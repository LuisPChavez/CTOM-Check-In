<!DOCTYPE html>

<style>
    body {
        background-image: url("./src/ctoMixersCups.png"), url("./src/background.png");
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: left bottom, center;
    }

    .container {
        display: flex;
        justify-content: center;
        flex-direction: row;
    }

    .containerForCameraAndText {
        flex-direction: row;
        justify-content: space-around;
        flex-wrap: wrap;
        display: flex;      
    }


</style>

<html>
  <head>
    <meta charset="UTF-8">
    <title>CTO Mixers Check In!</title>
  </head>
  <body>
    <div class="container"x>
        <img src="./src/ctoMixers.jpg" alt="CTO Mixers Pic" style="height: 300px; width: 600px">
    </div>
    <div class="containerForCameraAndText">

        <video id="video" width="640" height="480" autoplay></video>
        <div>
            <img src="./src/CheckIn.png" style="height: 400px; width: 400px">
            <h1 id="GuestName"></h1>
        </div>
        <canvas id="canvas" width="640" height="480"></canvas>

    </div>
  </body>
</html>

<script>
    // Grab elements, create settings, etc.
     var video = document.getElementById('video'); 

    // Get access to the camera!

    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Not adding `{ audio: true }` since we only want video now
        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
            video.src = window.URL.createObjectURL(stream);
            video.play();
        });
    }

    
    var canvas = document.getElementById('canvas');
    var context = canvas.getContext('2d');
    var video = document.getElementById('video');
/*
    var request = new XMLHttpRequest();
        request.open('POST', 'https://api.kairos.com/gallery/remove_subject');

        request.setRequestHeader('Content-Type', 'application/json');
        request.setRequestHeader('app_id', '87fbd2da');
        request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');

        request.onreadystatechange = function () {
            if (this.readyState === 4) {
                console.log('Status:', this.status);
                console.log('Headers:', this.getAllResponseHeaders());
                console.log('Body:', this.responseText);
            }
        };


    var body = {
        'gallery_name': 'TheGallery',
        'subject_id': 'Luis-Chavez'
    };

    request.send(JSON.stringify(body));

*/

    var base64Pic;
    //console.log(video);
    function viewList() {
        var request = new XMLHttpRequest();
        request.open('POST', 'https://api.kairos.com/gallery/view');

        request.setRequestHeader('Content-Type', 'application/json');
        request.setRequestHeader('app_id', '87fbd2da');
        request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');

        request.onreadystatechange = function () {
            if (this.readyState === 4) {
                console.log('Status:', this.status);
                console.log('Headers:', this.getAllResponseHeaders());
                console.log('Body:', this.responseText);
            }
        };
    

        var body = {
            'gallery_name': 'TheGallery'
        };

        request.send(JSON.stringify(body));
    }

    viewList();

    function enrollPeople() {
        const nativeImage = require('electron').nativeImage

        let image = nativeImage.createFromPath('./Guests/default.png');
        //console.log(image);
        var base64Pic = image.toDataURL();

        var request = new XMLHttpRequest();

        request.open('POST', 'https://api.kairos.com/enroll');

        request.setRequestHeader('Content-Type', 'application/json');
        request.setRequestHeader('app_id', '87fbd2da');
        request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');

        request.onreadystatechange = function () {
            if (this.readyState === 4) {
                console.log('Status:', this.status);
                console.log('Headers:', this.getAllResponseHeaders());
                console.log('Body:', this.responseText);
            }
        };


        

        var body = {
            'image': base64Pic,
            'subject_id': 'Luis-Chavez',
            'gallery_name': 'TheGallery',
        };



        request.send(JSON.stringify(body));
    }

    enrollPeople();

    function takePicture() {
        canvas = document.getElementById('canvas');
        canvas.style.visibility = "hidden";
        context = canvas.getContext('2d');
        video = document.getElementById('video');
        var info;

        console.log(video.src);
        console.log("Picture taken");
        context.drawImage(video, 0, 0, 640, 480);
        var base64Str3 = canvas.toDataURL();

        

        var request = new XMLHttpRequest();
        
        request.open('POST', 'https://api.kairos.com/recognize');
        
        request.setRequestHeader('Content-Type', 'application/json');
        request.setRequestHeader('app_id', '87fbd2da');
        request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');
        
        request.onreadystatechange = function () {
          if (this.readyState === 4) {
            console.log('Status:', this.status);
            console.log('Headers:', this.getAllResponseHeaders());
            console.log('Body:', this.responseText);

            info = JSON.parse(this.responseText);
            if("Errors" in info || info.images[0].transaction.status == "failure") {
                var nameOfGuest = info.images[0].transaction.subject_id;
                var element = document.getElementById("GuestName");
                element.innerHTML = "";
                console.log("NO MATCH");
            }
            else {
                var nameOfGuest = info.images[0].transaction.subject_id;
                var element = document.getElementById("GuestName");
                element.innerHTML = "Welcome " + nameOfGuest + "!";
                console.log(nameOfGuest);
                console.log("MATCH");
            }
          }
        };

        var body = {
          'image': base64Str3,
          'gallery_name' : 'TheGallery'
        };
        
        request.send(JSON.stringify(body));
    }
    
    setInterval(takePicture, 4000);

    


    
    // Trigger photo take
    /*
    document.getElementById("snap").addEventListener("click", function() {
        context.drawImage(video, 0, 0, 640, 480);
    });
    */
</script>
