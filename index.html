<!DOCTYPE html>

<style>
    body {
        background-image: url("./src/ctoMixersCups.png"), url("./src/background.png");
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: left bottom, center;
    }

    h1 {
        font-family: 'Candal';
        font-size: 35px;
        color: white;
    }

    .container {
        display: flex;
        justify-content: center;
        flex-direction: row;
    }

    .containerForCameraAndText {
        justify-content: space-around;
        flex-wrap: wrap;
        display: flex;      
    }

    .checkMark {
        padding-left: 70px;
    }


    .form-style-5{
        max-width: 500px;
        padding: 10px 20px;
        background: #f4f7f8;
        margin: 10px auto;
        padding: 20px;
        background: #f4f7f8;
        border-radius: 8px;
        font-family: Georgia, "Times New Roman", Times, serif;
    }
    .form-style-5 fieldset{
        border: none;
    }
    .form-style-5 legend {
        font-size: 1.4em;
        margin-bottom: 10px;
        justify-content: center;
    }
    .form-style-5 label {
        display: block;
        margin-bottom: 8px;
    }
    .form-style-5 input[type="text"],
    .form-style-5 input[type="email"],
    .form-style-5 textarea,
    .form-style-5 select {
        font-family: Georgia, "Times New Roman", Times, serif;
        background: rgba(255,255,255,.1);
        border: none;
        border-radius: 4px;
        font-size: 16px;
        margin: 0;
        outline: 0;
        padding: 7px;
        width: 100%;
        box-sizing: border-box; 
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box; 
        background-color: #e8eeef;
        color:#8a97a0;
        -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.03) inset;
        box-shadow: 0 1px 0 rgba(0,0,0,0.03) inset;
        margin-bottom: 30px;
    
    }
    .form-style-5 input[type="text"]:focus,
    .form-style-5 input[type="email"]:focus,
    .form-style-5 textarea:focus,
    .form-style-5 select:focus{
        background: #d2d9dd;
    }
    .form-style-5 select{
        -webkit-appearance: menulist-button;
        height:35px;
    }


    .form-style-5 input[type="submit"],
    .form-style-5 input[type="button"]
    {
        position: relative;
        display: block;
        padding: 19px 39px 18px 39px;
        color: #FFF;
        margin: 0 auto;
        background: #1abc9c;
        font-size: 18px;
        text-align: center;
        font-style: normal;
        width: 100%;
        border: 1px solid #16a085;
        border-width: 1px 1px 3px;
        margin-bottom: 10px;
    }
    .form-style-5 input[type="submit"]:hover,
    .form-style-5 input[type="button"]:hover
    {
        background: #109177;
    }

    .form-style {
        padding: 1;
        background-color: #e6e6e6;
        padding: 5px 70px 0px 70px;
    }
</style>

<html>
  <head>
    <link href='https://fonts.googleapis.com/css?family=Candal' rel='stylesheet'>
    <meta charset="UTF-8">
    <title>CTO Mixers Check In!</title>
  </head>
  <body>
    <div class="container">
        <img src="./src/ctoMixers.jpg" alt="CTO Mixers Pic" style="height: 300px; width: 600px">
    </div>
    <div class="containerForCameraAndText">
        <video id="video" width="640" height="480" autoplay></video>
        <div class="form-style">
            <!--
            <div class="form-style-5">
                <form>
                    <fieldset>

                        
                        <legend>Guest Info</legend>
                        <input type="text" name="field1" placeholder="First Name *">
                        <input type="text" name="field2" placeholder="Last Name *"> 
                        <input type="email" name="field3" placeholder="Email *">
                        <input type="text" name="field4" placeholder="Company ">  
                    </fieldset>
                    <input type="submit" value="Apply" />
                </form>
            </div>
            -->
            <iframe src="http://go.dws.la/l/345901/2018-01-25/59n577" width="100%" height="500" type="text/html" frameborder="0" allowTransparency="true" style="border: 0"></iframe>
            <!--<h1 id="GuestName">Don't see anyone yet!</h1>-->
            <button type="button" onclick="takePicture2()">Click Me!</button>
        </div>
        <img src="./src/CheckInEmpty.png" style="height:400px; width: 900px" style="padding-left: 60px;">
        <canvas id="canvas" width="640" height="480"></canvas>
    </div>
  </body>
</html>

<script>
    
    var guestData;

    function takePicture2() {
        canvas = document.getElementById('canvas');
        canvas.style.visibility = "hidden";
        context = canvas.getContext('2d');
        video = document.getElementById('video');
        var info;

        //console.log(video.src);
        console.log("Picture taken");
        context.drawImage(video, 0, 0, 640, 480);
        var base64Str = canvas.toDataURL("image/png");
        
        base64Str = base64Str.replace("data:image/png;base64,", "");
        var filePath = "C:/Users/unsto/CTOM-Check-In/GuestPictures/";


        var fs = require('fs');
        fs.writeFile('C:/Users/unsto/CTOM-Check-In/GuestPictures/test2.png', base64Str , 'base64', function (err) {
            if (err) throw err
            console.log('Saved!');
        });
    }
    //readJsonData();

    //Function reads data from a Json file which has all the info about guests. Json file is then used to enroll the list
    //which is what Kairos uses as a base to matches faces with.
    function readJsonData() {
        const storage = require('electron-storage');
        storage.get('guestList.json', function(error, data) {
            if (error) throw error;
            guestData = data;
            enrollList();
        });
    }



    // Grab elements, create settings, etc.
     var video = document.getElementById('video'); 

    // Get access to the camera!

    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        // Not adding `{ audio: true }` since we only want video now
        navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
            video.src = window.URL.createObjectURL(stream);
            video.play();
        });
    }

    //Removes the attendee list so a new one could be added.
    function removeList() {
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var video = document.getElementById('video');

        var request = new XMLHttpRequest();
            request.open('POST', 'https://api.kairos.com/gallery/remove');
            request.setRequestHeader('Content-Type', 'application/json');
            request.setRequestHeader('app_id', '87fbd2da');
            request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');

            request.onreadystatechange = function () {
                if (this.readyState === 4) {
                    //console.log('Status:', this.status);
                    //console.log('Headers:', this.getAllResponseHeaders());
                    //console.log('Body:', this.responseText);
                }
            };


        var body = {
            'gallery_name': 'CTOMGallery',
            'subject_id': 'Joe Devon'
        };
    
        request.send(JSON.stringify(body));
    }

    //removeList();


    //Function console.logs everyone on the list Karios is using to match faces with.
    var base64Pic;
    function viewList() {
        var request = new XMLHttpRequest();
        request.open('POST', 'https://api.kairos.com/gallery/view');

        request.setRequestHeader('Content-Type', 'application/json');
        request.setRequestHeader('app_id', '87fbd2da');
        request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');

        request.onreadystatechange = function () {
            if (this.readyState === 4) {
                //console.log('Status:', this.status);
                //console.log('Headers:', this.getAllResponseHeaders());
                //console.log('Body:', this.responseText);
            }
        };
    

        var body = {
            'gallery_name': 'CTOMGallery'
        };

        request.send(JSON.stringify(body));
    }

    //viewList();
    
    //Function looks at json file and enrolls them in the list Kairos uses to matches faces with.
    function enrollList() {
        //console.log(guestData);
        for( var i = 0; i < guestData.length; i++) {
            var guestId = guestData[i].lastName + "-" +guestData[i].firstName;

            const nativeImage = require('electron').nativeImage;
            var imageURL = "./Guests/" + guestId + ".png";
            console.log(imageURL);
            let image = nativeImage.createFromPath(imageURL);
            var base64Pic = image.toDataURL();

            var request = new XMLHttpRequest();

            request.open('POST', 'https://api.kairos.com/enroll');

            request.setRequestHeader('Content-Type', 'application/json');
            request.setRequestHeader('app_id', '87fbd2da');
            request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');

            request.onreadystatechange = function () {
                if (this.readyState === 4) {
                    console.log('Status:', this.status);
                    console.log('Headers:', this.getAllResponseHeaders());
                    console.log('Body:', this.responseText);
                }   
            };

            var body = {
                'image': base64Pic,
                'subject_id': guestId, 
                'gallery_name': 'CTOMGallery',
            };

            request.send(JSON.stringify(body));
            
        }
        
    }

    //Function is used to enroll a single person. Used for testing!
    function enrollTest() {
            var request = new XMLHttpRequest();

            request.open('POST', 'https://api.kairos.com/enroll');

            request.setRequestHeader('Content-Type', 'application/json');
            request.setRequestHeader('app_id', '87fbd2da');
            request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');

            request.onreadystatechange = function () {
                if (this.readyState === 4) {
                    console.log('Status:', this.status);
                    console.log('Headers:', this.getAllResponseHeaders());
                    console.log('Body:', this.responseText);
                }   
            };

            var body = {
                'image': 'https://cdn.evbuc.com/eventlogos/82410427/chavezluis.png',
                'subject_id': 'Joe Devon',
                'gallery_name': 'CTOMGallery',
            };

            request.send(JSON.stringify(body));
    }
    //enrollTest();

    //Function takes a picture every 2.5 seconds(Kairos API limits us to 25 calls a minute) and then calls 
    //Kairos to see if a person is in the picture and then tries to match that person's face with one
    //in the list. If they are matched with someone the function then changes the json file so the person 
    //is checked in. If they are already checked in a message will pop up for the guest.
    function takePicture() {
        canvas = document.getElementById('canvas');
        canvas.style.visibility = "hidden";
        context = canvas.getContext('2d');
        video = document.getElementById('video');
        var info;

        //console.log(video.src);
        console.log("Picture taken");
        context.drawImage(video, 0, 0, 640, 480);
        var base64Str = canvas.toDataURL();
        
        var request = new XMLHttpRequest();
        
        request.open('POST', 'https://api.kairos.com/recognize');
        
        request.setRequestHeader('Content-Type', 'application/json');
        request.setRequestHeader('app_id', '87fbd2da');
        request.setRequestHeader('app_key', '88d1dfeed8460e409e85e9d429873b22');
        
        request.onreadystatechange = function () {
          if (this.readyState === 4) {
            console.log('Status:', this.status);
            console.log('Headers:', this.getAllResponseHeaders());
            console.log('Body:', this.responseText);

            info = JSON.parse(this.responseText);
            if("Errors" in info || info.images[0].transaction.status == "failure") {

                var element = document.getElementById("GuestName");
                element.innerHTML = "Sorry! Are you on the RSVP List?";

                document.getElementById("CheckMark").src = "./src/CheckInEmpty.png";
                console.log("NO MATCH");
            }
            else {
                var nameOfGuest = info.images[0].transaction.subject_id;
                  var element = document.getElementById("GuestName");

                    //document.getElementById("CheckMark").src = "./src/CheckIn.png";
                
                for( var i = 0; i < guestData.length; i++) {
                    var guestId = guestData[i].lastName + "-" + guestData[i].firstName;
                    var guestNameForPrint = guestData[i].firstName + " " + guestData[i].lastName;
                    if( guestId == nameOfGuest)
                    {
                        if(guestData[i].checkedIn == true) {
                            element.innerHTML = "You already checked in " + guestNameForPrint + "!";
                        }
                        else {
                            element.innerHTML = "You're checked in " + guestNameForPrint + "!";
                            guestData[i].checkedIn = true;
                            //readJsonData();
                            const storage = require('electron-storage');
                            storage.set('guestList.json', guestData) 
                            .then(() => {
                                console.log('The file was successfully written to the storage');
                            })
                            .catch(err => {
                                console.error(err);
                            });

                        }
                    }
                }

                console.log("MATCH");
            }
          }
        };

        var body = {
          'image': base64Str,
          'gallery_name' : 'CTOMGallery'
        };
        
        request.send(JSON.stringify(body));
    }
    
    setInterval(takePicture, 2500);

</script>
